---
title: "시스템 간 비동기 연동, 이 3가지만 통달하면 끝이다"
description: "메시징 / 데이터베이스(Outbox·Inbox 포함) / CDC"
date: 2025-08-30 10:00:00 +0900
categories: [CS, Common]
tags: [Computer Science, Common, Idempotency, API]
---

# 시스템 간 비동기 연동, 이 3가지만 통달하면 끝이다

**메시징 / 데이터베이스(Outbox·Inbox 포함) / CDC**

## 주문 버튼 뒤에서 벌어지는 일: 메시지 큐, 아웃박스/인박스, CDC

사용자가 “주문하기”를 누르면 실제론 메일 발송, 포인트 적립, 슬랙 알림, 검색 색인, 통계 적재까지 줄줄이 이어진다. 이걸 전부 **동기**로 하면 응답이 느려지고, 하나만 실패해도 전체 롤백될 수 있다. 그래서 **비동기 연동**을 쓴다.
실무에선 보통 아래 **세 가지 무기**를 섞어 쓴다:

* **메시지 큐**(Kafka, RabbitMQ): 이벤트를 발행하고 다른 서비스가 구독해서 처리
* **아웃박스/인박스**(DB 활용): “DB 변경 + 이벤트 기록”을 **같이 커밋**해 원자성 해결
* **CDC**(Change Data Capture): DB 변경 로그를 **그대로 스트리밍**

---

## 1) 메시지 큐: “발행하고, 필요한 쪽이 가져간다”

**개념**
주문 서비스가 **토픽/큐**에 메시지를 넣고, 메일/포인트/통계 서비스가 **구독**해서 각자 처리한다. 파티션과 컨슈머 그룹으로 **수평 확장**이 쉽다.

**언제 좋나**

* 여러 팀/서비스가 같은 이벤트를 **각자** 소비해야 할 때
* **리플레이**(특정 시점부터 다시 읽기)가 필요할 때
* 트래픽 피크에 맞춰 **처리량 확장**이 중요한 시스템

**꼭 챙길 것(국룰 체크)**

* **전달 방식**: 현실적으로 대부분 **at-least-once** → **중복 처리 대비**(멱등성 키: 주문ID 등)
* **순서 보장**: **파티션 키** 범위에서만 보장됨 → 키 설계(사용자ID/주문ID 같은 “같이 묶여야 하는 단위”)
* **문제 메시지**: 재시도는 **지수 백오프**, 그래도 안 되면 **DLQ**(죽은 편지함)로 격리
* **dual-write**: “DB는 성공, 큐 발행은 실패(또는 반대)” 문제 → 밑의 **아웃박스**로 해결

> 한 줄 팁: “순서가 중요하면 **같은 키**로 같은 파티션에 박는다.”

---

## 2) 아웃박스/인박스: “DB에 영수증을 같이 남긴다”

**개념**
주문을 저장할 때, **같은 트랜잭션** 안에서 **아웃박스 테이블**에 “이벤트 기록”도 함께 남긴다.
배치나 워커가 아웃박스를 읽어 **브로커**로 내보낸다.
소비자 쪽은 **인박스 테이블**을 두어, 같은 메시지가 두 번 와도 **한 번만 처리**되게 한다.

**왜 쓰나**

* **원자성**: “비즈니스 쓰기 + 이벤트 기록”을 **한 번에 커밋** → dual-write 깔끔히 해결
* **확장성**: 이후 경로는 메시지 큐의 장점(리플레이/다중 구독)을 그대로 사용

**운영 포인트**

* 아웃박스 스키마 예: `event_type, aggregate_id, idempotency_key, payload(json), created_at, processed_at, attempts`
* **정리 정책**: TTL/아카이브, 파티션/인덱스 관리
* 릴레이어(아웃박스→브로커)는 **재시도 가능**하게, 소비자는 **멱등 처리**로 안전망 이중화

**간단 예시(의미만 전달)**

```python
# 주문 저장 + 아웃박스 기록(같은 트랜잭션)
with transaction.atomic():
    order = Order.objects.create(user_id=u, status='CREATED')
    Outbox.objects.create(
        event_type='order.created',
        aggregate_id=str(order.id),
        idempotency_key=f'order:{order.id}',
        payload={'order_id': order.id}
    )
# 워커가 Outbox 읽어서 Kafka/RabbitMQ로 발행
# 소비자는 Inbox 테이블에 처리 기록을 남겨 중복 방지
```

**DB를 큐처럼 쓰는 폴링 방식**도 같은 가족이다(브로커 없이 아웃박스만).
시작은 간단하지만, 트래픽이 커지면 **DB가 병목**이라 보통 **아웃박스→브로커**로 자연스럽게 확장한다.

---

## 3) CDC: “DB 커밋이 곧 이벤트 스트림”

**개념**
DB의 **변경 로그(binlog/WAL)**를 읽어 **변경 사항**을 스트리밍한다(Debezium 계열 많이 씀).
검색 인덱스, 데이터 웨어하우스, 캐시 동기화 등에 적합하다.

**장점**

* 애플리케이션에 “발행 코드”를 안 써도 됨 → **단순**
* **트랜잭션 경계**와 **순서**가 DB 커밋 기준으로 자연스럽게 반영

**주의할 점**

* **도메인 맥락**이 약함: “왜 바뀌었는지”는 로그에 없음 → 비즈니스 로직엔 **명시적 이벤트**가 더 낫다
* **스키마 변경** 시 커넥터/소비자 **호환성 관리** 필요
* **초기 스냅샷** 부하, 삭제 처리(tombstone), upsert 정책 결정
* 개인정보는 **필드 마스킹/필터링**을 기본으로

---

## 뭘 고를지 헷갈리면, 이렇게 생각하자

* **여러 팀이 같은 이벤트를 같이 쓰고, 리플레이/확장이 중요** → **메시지 큐**(+ 아웃박스로 원자성 해결)
* **원자성이 제일 중요하고, 작게 시작** → **DB 폴링** → 커지면 **아웃박스→브로커**
* **소스 DB 변경을 데이터 파이프라인/검색/캐시에 그대로** → **CDC**
* **“왜 일어났는지”가 중요(도메인 이벤트)** → **아웃박스 중심**. CDC는 보조로

---

## 필수 안전장치(이 세 가지면 사고 확 줄어든다)

1. **멱등성 키**: 이벤트마다 고유 키(주문ID 등). 중복 수신에도 **한 번만 반영**
2. **DLQ + 지수 백오프**: 계속 실패하는 메시지는 격리하고, 천천히 재시도
3. **관찰성**: 소비 지연(consumer lag), 실패율, 재시도 횟수, 아웃박스 적체량을 **대시보드**로 상시 확인

---

## 그림으로 한 방에 보기(이름을 한국식으로)

```
[주문 API] --트랜잭션--> [DB: 비즈니스 + 아웃박스]
         \                                 |
          \----(옵션: CDC)-----------------|
                           워커/커넥터
                                |
                          [메시지 큐]
                                |
                         [메일/포인트/통계]
                           (인박스로 멱등)
```

* **아웃박스**는 **원자성**, **메시지 큐**는 **확장성**, **CDC**는 **데이터 동기화**에 강하다.
* 보통은 **아웃박스 + 메시지 큐**를 기본으로 깔고, **CDC는 데이터 쪽**(DW/검색/캐시)에 붙인다.

---

## 당장 써먹는 체크리스트

* [ ] 이벤트마다 **멱등성 키**(예: `order:{id}`) 붙였는가
* [ ] **아웃박스** 테이블 만들고, 비즈니스 쓰기와 **같이 커밋**하는가
* [ ] 소비자에 **인박스**로 “정확히 한 번처럼 보이게” 처리하는가
* [ ] **DLQ/재시도** 정책과 알림을 설정했는가
* [ ] **스키마 버전**과 호환성(뒤로 호환)을 문서화했는가

### 더 알아보기
👉 [[최범균님 유튜브] 초식 - 시스템 간 비동기 연동 4종 세트](https://www.youtube.com/watch?v=VIbMOSciFhg)    
👉 [[NHN FORWARD 22] 분산 시스템에서 데이터를 전달하는 효율적인 방법](https://www.youtube.com/watch?v=uk5fRLUsBfk)